(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class r{constructor(t,e){this.container=t,this.onClick=e,this.button=null}render(){return this.button=document.createElement("button"),this.button.className="chatbot-floating-btn",this.button.setAttribute("aria-label","채팅 열기"),this.button.innerHTML=`
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    `,this.button.addEventListener("click",()=>{this.onClick()}),this.container.appendChild(this.button),this.button}hide(){this.button&&(this.button.style.display="none")}show(){this.button&&(this.button.style.display="flex")}}class c{constructor(t,e){this.container=t,this.options=e,this.header=null,this.backBtn=null,this.menuBtn=null,this.showBackButton=!1}render(){this.header=document.createElement("div"),this.header.className="chatbot-header";const t=document.createElement("div");t.className="chatbot-header-actions",this.backBtn=document.createElement("button"),this.backBtn.className="chatbot-header-back",this.backBtn.setAttribute("aria-label","뒤로가기"),this.backBtn.style.display="none",this.backBtn.innerHTML=`
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    `,this.backBtn.addEventListener("click",()=>{this.options.onBack&&this.options.onBack()}),t.appendChild(this.backBtn),this.header.appendChild(t);const e=document.createElement("div");e.className="chatbot-header-info";const s=document.createElement("h3");s.className="chatbot-header-title",s.textContent=this.options.title||"고객센터";const i=document.createElement("p");i.className="chatbot-header-subtitle",i.textContent=this.options.subtitle||"무엇을 도와드릴까요?",e.appendChild(s),e.appendChild(i),this.header.appendChild(e);const n=document.createElement("div");n.className="chatbot-header-actions",this.menuBtn=document.createElement("button"),this.menuBtn.className="chatbot-header-menu",this.menuBtn.setAttribute("aria-label","채팅방 목록"),this.menuBtn.innerHTML=`
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    `,this.menuBtn.addEventListener("click",()=>{this.options.onMenu&&this.options.onMenu()});const o=document.createElement("button");return o.className="chatbot-header-close",o.setAttribute("aria-label","닫기"),o.innerHTML=`
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    `,o.addEventListener("click",()=>{this.options.onClose&&this.options.onClose()}),n.appendChild(this.menuBtn),n.appendChild(o),this.header.appendChild(n),this.container.appendChild(this.header),this.header}setBackButton(t){this.backBtn&&(this.backBtn.style.display=t?"flex":"none"),this.menuBtn&&(this.menuBtn.style.display=t?"none":"flex")}}class d{constructor(t,e){this.container=t,this.message=e,this.bubble=null}render(){this.bubble=document.createElement("div"),this.bubble.className=`chatbot-bubble ${this.message.role.toLowerCase()}`;const t=document.createElement("div");t.className="chatbot-bubble-content",t.textContent=this.message.content,t.innerHTML=this.formatContent(this.message.content);const e=document.createElement("div");return e.className="chatbot-bubble-time",e.textContent=this.formatTime(this.message.createdAt||new Date),this.bubble.appendChild(t),this.bubble.appendChild(e),this.container.appendChild(this.bubble),this.bubble}formatContent(t){return t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}formatTime(t){const e=new Date(t),s=e.getHours().toString().padStart(2,"0"),i=e.getMinutes().toString().padStart(2,"0");return`${s}:${i}`}}class u{constructor(t){this.container=t,this.list=null,this.messages=[],this.typingIndicator=null}render(){return this.list=document.createElement("div"),this.list.className="chatbot-message-list",this.container.appendChild(this.list),this.list}addMessage(t){const e=new d(this.list,t);e.render(),this.messages.push(e),this.scrollToBottom()}showTypingIndicator(){this.typingIndicator||(this.typingIndicator=document.createElement("div"),this.typingIndicator.className="chatbot-typing-indicator",this.typingIndicator.innerHTML=`
      <div class="chatbot-bubble assistant">
        <div class="chatbot-typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    `,this.list.appendChild(this.typingIndicator),this.scrollToBottom())}hideTypingIndicator(){this.typingIndicator&&(this.typingIndicator.remove(),this.typingIndicator=null)}scrollToBottom(){this.list&&setTimeout(()=>{this.list.scrollTop=this.list.scrollHeight},100)}clear(){this.list&&(this.list.innerHTML="",this.messages=[])}}class p{constructor(t,e){this.container=t,this.onClick=e,this.repliesContainer=null,this.replies=[]}render(){return this.repliesContainer=document.createElement("div"),this.repliesContainer.className="chatbot-quick-replies",this.repliesContainer.style.display="none",this.container.appendChild(this.repliesContainer),this.repliesContainer}setReplies(t){if(this.repliesContainer){if(this.replies=t||[],this.repliesContainer.innerHTML="",this.replies.length===0){this.repliesContainer.style.display="none";return}this.repliesContainer.style.display="flex",this.replies.forEach(e=>{const s=document.createElement("button");if(s.className="chatbot-quick-reply-btn",e.icon){const n=document.createElement("span");n.className="chatbot-quick-reply-icon",n.textContent=e.icon,s.appendChild(n)}const i=document.createElement("span");i.textContent=e.label,s.appendChild(i),s.addEventListener("click",()=>{this.onClick&&this.onClick(e.value),this.repliesContainer.style.display="none"}),this.repliesContainer.appendChild(s)})}}}class m{constructor(t,e){this.container=t,this.onSend=e,this.inputContainer=null,this.input=null,this.sendBtn=null}render(){return this.inputContainer=document.createElement("div"),this.inputContainer.className="chatbot-input-container",this.input=document.createElement("input"),this.input.type="text",this.input.className="chatbot-input",this.input.placeholder="메시지를 입력하세요...",this.input.setAttribute("maxlength","10000"),this.input.addEventListener("keypress",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.send())}),this.sendBtn=document.createElement("button"),this.sendBtn.className="chatbot-send-btn",this.sendBtn.setAttribute("aria-label","전송"),this.sendBtn.innerHTML=`
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    `,this.sendBtn.addEventListener("click",()=>this.send()),this.inputContainer.appendChild(this.input),this.inputContainer.appendChild(this.sendBtn),this.container.appendChild(this.inputContainer),this.inputContainer}send(){const t=this.input.value.trim();t&&this.onSend&&(this.onSend(t),this.input.value="")}focus(){this.input&&setTimeout(()=>{this.input.focus()},100)}setDisabled(t){this.input&&(this.input.disabled=t),this.sendBtn&&(this.sendBtn.disabled=t)}}class w{constructor(t,e={}){this.container=t,this.options=e,this.list=null,this.sessions=[],this.currentSessionToken=null,this.onSessionSelect=e.onSessionSelect||null,this.onNewChat=e.onNewChat||null}render(){this.list=document.createElement("div"),this.list.className="chatbot-session-list";const t=document.createElement("div");t.className="chatbot-session-list-header";const e=document.createElement("h3");e.textContent="대화 목록",t.appendChild(e);const s=document.createElement("button");s.className="chatbot-session-new-btn",s.setAttribute("aria-label","새 대화 시작"),s.innerHTML=`
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    `,s.addEventListener("click",()=>{this.onNewChat&&this.onNewChat()}),t.appendChild(s),this.list.appendChild(t);const i=document.createElement("div");return i.className="chatbot-session-list-container",this.list.appendChild(i),this.container.appendChild(this.list),this.list}setSessions(t){this.sessions=t,this.renderSessions()}setCurrentSession(t){this.currentSessionToken=t,this.renderSessions()}renderSessions(){const t=this.list.querySelector(".chatbot-session-list-container");if(t){if(t.innerHTML="",this.sessions.length===0){const e=document.createElement("div");e.className="chatbot-session-list-empty",e.textContent="대화 내역이 없습니다",t.appendChild(e);return}this.sessions.forEach(e=>{const s=document.createElement("div");s.className="chatbot-session-item",e.sessionToken===this.currentSessionToken&&s.classList.add("active");const i=document.createElement("div");i.className="chatbot-session-title",i.textContent=e.title||"새 대화";const n=document.createElement("div");n.className="chatbot-session-preview",n.textContent=e.lastMessagePreview||"";const o=document.createElement("div");o.className="chatbot-session-meta";const h=document.createElement("span");h.className="chatbot-session-count",h.textContent=`${e.messageCount}개`;const l=document.createElement("span");l.className="chatbot-session-time",l.textContent=this.formatTime(e.lastMessageAt),o.appendChild(h),o.appendChild(l),s.appendChild(i),s.appendChild(n),s.appendChild(o),s.addEventListener("click",()=>{this.onSessionSelect&&this.onSessionSelect(e.sessionToken)}),t.appendChild(s)})}}formatTime(t){if(!t)return"";const e=new Date(t),i=new Date-e,n=Math.floor(i/6e4),o=Math.floor(i/36e5),h=Math.floor(i/864e5);return n<1?"방금 전":n<60?`${n}분 전`:o<24?`${o}시간 전`:h<7?`${h}일 전`:e.toLocaleDateString("ko-KR",{month:"short",day:"numeric"})}show(){this.list&&(this.list.style.display="flex")}hide(){this.list&&(this.list.style.display="none")}}class g{constructor(t,e){this.container=t,this.config=e,this.window=null,this.header=null,this.sessionList=null,this.messageContainer=null,this.messageList=null,this.quickReplies=null,this.inputBox=null,this.isVisible=!1,this.currentView="chat",this.onClose=null,this.onSendMessage=null,this.onSessionSelect=null,this.onNewChat=null}render(){return this.window=document.createElement("div"),this.window.className="chatbot-window",this.window.style.display="none",this.header=new c(this.window,{title:this.config.title||"고객센터",subtitle:this.config.subtitle||"무엇을 도와드릴까요?",onClose:()=>this.close(),onMenu:()=>this.showSessionList(),onBack:()=>this.showChat()}),this.header.render(),this.sessionList=new w(this.window,{onSessionSelect:t=>{this.onSessionSelect&&this.onSessionSelect(t)},onNewChat:()=>{this.onNewChat&&this.onNewChat()}}),this.sessionList.render(),this.sessionList.hide(),this.messageContainer=document.createElement("div"),this.messageContainer.className="chatbot-message-container",this.messageList=new u(this.messageContainer),this.messageList.render(),this.quickReplies=new p(this.messageContainer,t=>{this.onSendMessage&&this.onSendMessage(t)}),this.quickReplies.render(),this.window.appendChild(this.messageContainer),this.inputBox=new m(this.window,t=>{this.onSendMessage&&this.onSendMessage(t)}),this.inputBox.render(),this.container.appendChild(this.window),this.window}showSessionList(){this.currentView="sessions",this.sessionList&&this.sessionList.show(),this.messageContainer&&(this.messageContainer.style.display="none"),this.inputBox&&this.inputBox.container&&(this.inputBox.container.style.display="none"),this.header&&this.header.setBackButton(!0)}showChat(){this.currentView="chat",this.sessionList&&this.sessionList.hide(),this.messageContainer&&(this.messageContainer.style.display="flex"),this.inputBox&&this.inputBox.container&&(this.inputBox.container.style.display="flex"),this.header&&this.header.setBackButton(!1)}setSessions(t){this.sessionList&&this.sessionList.setSessions(t)}setCurrentSession(t){this.sessionList&&this.sessionList.setCurrentSession(t)}clearMessages(){this.messageList&&this.messageList.clear()}open(){this.window&&(this.window.style.display="flex",this.isVisible=!0,this.currentView==="chat"&&this.inputBox.focus())}close(){this.window&&(this.window.style.display="none",this.isVisible=!1,this.onClose&&this.onClose())}toggle(){this.isVisible?this.close():this.open()}addMessage(t){this.messageList&&this.messageList.addMessage(t)}setQuickReplies(t){this.quickReplies&&this.quickReplies.setReplies(t)}setLoading(t){this.inputBox&&this.inputBox.setDisabled(t),t&&this.messageList?this.messageList.showTypingIndicator():this.messageList&&this.messageList.hideTypingIndicator()}}class f{constructor(t={}){this.config={apiUrl:t.apiUrl||window.location.origin,title:t.title||"고객센터",subtitle:t.subtitle||"무엇을 도와드릴까요?",primaryColor:t.primaryColor||"#E17055",...t},this.container=null,this.shadowRoot=null,this.floatingButton=null,this.chatWindow=null,this.sessionToken=null,this.sessions=[],console.log("Chatbot Widget initialized",this.config)}async init(){this.container=document.createElement("div"),this.container.className="chatbot-widget",this.shadowRoot=this.container.attachShadow({mode:"open"});const t=document.createElement("link");t.rel="stylesheet",t.href=`${this.config.apiUrl}/widget/styles.css`,this.shadowRoot.appendChild(t);const e=document.createElement("div");if(e.className="chatbot-widget",this.shadowRoot.appendChild(e),this.config.primaryColor){const s=document.createElement("style");s.textContent=`:root { --primary-color: ${this.config.primaryColor}; }`,this.shadowRoot.appendChild(s)}this.floatingButton=new r(e,()=>{this.toggleChat()}),this.floatingButton.render(),this.chatWindow=new g(e,this.config),this.chatWindow.render(),this.chatWindow.onClose=()=>{this.floatingButton.show()},this.chatWindow.onSendMessage=s=>{this.sendMessage(s)},this.chatWindow.onSessionSelect=s=>{this.switchSession(s)},this.chatWindow.onNewChat=()=>{this.createNewChat()},document.body.appendChild(this.container),await this.loadSessions(),await this.createSession(),console.log("Chatbot Widget ready")}async loadSessions(){try{const t=await fetch(`${this.config.apiUrl}/api/chatbot/sessions?limit=20`);if(!t.ok)throw new Error("Failed to load sessions");this.sessions=await t.json(),this.chatWindow.setSessions(this.sessions)}catch(t){console.error("Failed to load sessions:",t),this.sessions=[]}}async createSession(){try{const t=await fetch(`${this.config.apiUrl}/api/chatbot/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.config.userId})});if(!t.ok)throw new Error("Failed to create session");const e=await t.json();this.sessionToken=e.sessionToken,this.chatWindow.setCurrentSession(this.sessionToken),e.quickReplies&&e.quickReplies.length>0&&this.chatWindow.setQuickReplies(e.quickReplies),this.config.welcomeMessage&&this.chatWindow.addMessage({role:"ASSISTANT",content:this.config.welcomeMessage,createdAt:new Date}),await this.loadSessions()}catch(t){console.error("Failed to create session:",t)}}async createNewChat(){this.chatWindow.clearMessages(),await this.createSession(),this.chatWindow.showChat()}async switchSession(t){try{this.sessionToken=t,this.chatWindow.setCurrentSession(t),this.chatWindow.clearMessages(),await this.loadMessages(t),this.chatWindow.showChat()}catch(e){console.error("Failed to switch session:",e)}}async loadMessages(t){try{const e=await fetch(`${this.config.apiUrl}/api/chatbot/sessions/${t}/messages`);if(!e.ok)throw new Error("Failed to load messages");(await e.json()).forEach(i=>{this.chatWindow.addMessage(i)})}catch(e){console.error("Failed to load messages:",e)}}async toggleChat(){this.chatWindow.isVisible||await this.loadSessions(),this.chatWindow.toggle(),this.chatWindow.isVisible?this.floatingButton.hide():this.floatingButton.show()}async sendMessage(t){if(!this.sessionToken){console.error("No session token available");return}this.chatWindow.addMessage({role:"USER",content:t,createdAt:new Date}),this.chatWindow.setQuickReplies([]),this.chatWindow.setLoading(!0);try{const e=await fetch(`${this.config.apiUrl}/api/chatbot/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:t,sessionToken:this.sessionToken})});if(!e.ok)throw new Error("Failed to send message");const s=await e.json();this.chatWindow.setLoading(!1),this.chatWindow.addMessage({role:"ASSISTANT",content:s.content,metadata:s.metadata,createdAt:s.createdAt}),s.quickReplies&&s.quickReplies.length>0&&this.chatWindow.setQuickReplies(s.quickReplies),await this.loadSessions()}catch(e){console.error("Failed to send message:",e),this.chatWindow.setLoading(!1),this.chatWindow.addMessage({role:"ASSISTANT",content:"죄송합니다. 메시지 전송에 실패했습니다. 다시 시도해주세요.",createdAt:new Date})}}destroy(){this.container&&this.container.remove()}}window.chatbot=function(){const a=Array.from(arguments);if(a[0]==="init"){const e=a[1]||{},s=new f(e);return s.init(),s}};
